From db9efa8d40dc530c32f4da678b0842093ffe5cec Mon Sep 17 00:00:00 2001
From: gmh <gmh>
Date: Sat, 1 Jan 2022 20:48:31 +0800
Subject: [PATCH] [lld] [coff] Fix the characteristics of some sections like
 ".voltbl". Or the program will be crash sometimes.


 lld/COFF/Writer.cpp | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/lld/COFF/Writer.cpp b/lld/COFF/Writer.cpp
index 0788f3519f4e..e3c8c77f9dcc 100644
--- a/lld/COFF/Writer.cpp
+++ b/lld/COFF/Writer.cpp
@@ -1500,6 +1500,12 @@ template <typename PEHeaderTy> void Writer::writeHeader() {
 
   // Write section table
   for (OutputSection *sec : ctx.outputSections) {
+    // Fix the characteristics of some sections like ".voltbl".
+    // Or the program will be crash sometimes.
+    if (sec->header.Characteristics == 0) {
+      sec->header.Characteristics |= IMAGE_SCN_CNT_INITIALIZED_DATA |
+                                     IMAGE_SCN_MEM_READ | IMAGE_SCN_MEM_WRITE;
+    }
     sec->writeHeaderTo(buf);
     buf += sizeof(coff_section);
   }


